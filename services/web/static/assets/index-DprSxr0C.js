(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const o of e)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(e){const o={};return e.integrity&&(o.integrity=e.integrity),e.referrerPolicy&&(o.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?o.credentials="include":e.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(e){if(e.ep)return;e.ep=!0;const o=n(e);fetch(e.href,o)}})();let s,l,d,c;function T(){const i=document.getElementById("viewer-container"),t=i.clientWidth||window.innerWidth,n=i.clientHeight||window.innerHeight*.7;s=new THREE.Scene,s.background=new THREE.Color(15790320),l=new THREE.PerspectiveCamera(60,t/n,.1,100),l.position.set(0,1.5,3),d=new THREE.WebGLRenderer({antialias:!0}),d.setSize(t,n),i.innerHTML="",i.appendChild(d.domElement),c=new THREE.OrbitControls(l,d.domElement),c.enableDamping=!0;const a=new THREE.HemisphereLight(16777215,4473924,1);s.add(a);const e=new THREE.AxesHelper(1);s.add(e),E()}function E(){requestAnimationFrame(E),c&&c.update(),d&&s&&l&&d.render(s,l)}function h(){for(;s&&s.children.length>2;)s.remove(s.children[2])}function x(i){const t=document.getElementById("status");t&&(t.textContent+=`
Loading model: ${i}`);const n=i.toLowerCase();n.endsWith(".ply")?new THREE.PLYLoader().load(i,e=>{e.computeVertexNormals();const o=new THREE.MeshStandardMaterial({flatShading:!0}),r=new THREE.Mesh(e,o);r.castShadow=!0,r.receiveShadow=!0,r.position.set(0,0,0),r.scale.set(1,1,1),h(),s.add(r),t&&(t.textContent+=`
PLY model loaded.`)},void 0,e=>{console.error("PLY load error:",e),t&&(t.textContent+=`
Error loading PLY: ${e}`)}):n.endsWith(".gltf")||n.endsWith(".glb")?new THREE.GLTFLoader().load(i,e=>{h(),s.add(e.scene),t&&(t.textContent+=`
GLTF/GLB model loaded.`)},void 0,e=>{console.error("GLTF/GLB load error:",e),t&&(t.textContent+=`
Error loading GLTF/GLB: ${e}`)}):t&&(t.textContent+=`
Unknown model extension.`)}function g(){const i=document.getElementById("file-input"),t=document.getElementById("upload-btn"),n=document.getElementById("status");if(!i||!t||!n){console.error("Missing DOM elements");return}T();async function a(e){e.preventDefault();const o=i.files[0];if(!o){n.textContent="Please choose a .ply file first.";return}n.textContent="Initializing upload...";const r=await fetch("/api/init-upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:o.name})});if(!r.ok){n.textContent="init-upload failed.",console.error("init-upload status:",r.status);return}const u=await r.json(),{jobId:p,uploadUrl:w,downloadUrl:y,gcsPath:L}=u;console.log("initData:",u),n.textContent=`Job: ${p}
Uploading to GCS...
`;const m=await fetch(w,{method:"PUT",headers:{"Content-Type":"application/octet-stream"},body:o});if(!m.ok){n.textContent+=`
Upload failed.`,console.error("GCS upload status:",m.status);return}n.textContent+=`Upload complete.
Starting Trellis job...`;const f=await fetch("/api/start-job",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jobId:p,gcsPath:L})});if(!f.ok){n.textContent+=`
Trellis job start failed.`,console.error("start-job status:",f.status);return}const C=await f.json();n.textContent+=`
Trellis worker response: ${JSON.stringify(C)}`,await x(y),n.textContent+=`
PLY model loaded.`}t.addEventListener("click",a)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();
